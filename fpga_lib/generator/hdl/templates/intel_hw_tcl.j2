# {{ entity_name }}_hw.tcl - Intel Platform Designer Component Definition
# Generated by fpga_lib VHDL Generator
#
# Provides component integration for Intel Quartus Platform Designer (Qsys)
# with Avalon-MM slave interface for register access.
#
# Usage: Place this file in the same directory as your VHDL files and
#        add the directory to Platform Designer's IP search path.

# -----------------------------------------------------------------------------
# Package Definition
# -----------------------------------------------------------------------------
package require qsys

# -----------------------------------------------------------------------------
# Validation Callback
# -----------------------------------------------------------------------------
proc validate {} {
    # Add parameter validation here if needed
}

# -----------------------------------------------------------------------------
# Elaboration Callback
# -----------------------------------------------------------------------------
proc elaborate {} {
    # -----------------------------------------------------------------------------
    # Clock Interface
    # -----------------------------------------------------------------------------
    add_interface clk clock end
    set_interface_property clk clockRate 0
    set_interface_property clk ENABLED true
    set_interface_property clk EXPORT_OF ""
    set_interface_property clk PORT_NAME_MAP ""
    set_interface_property clk CMSIS_SVD_VARIABLES ""
    set_interface_property clk SVD_ADDRESS_GROUP ""
    
    add_interface_port clk clk clk Input 1
    
    # -----------------------------------------------------------------------------
    # Reset Interface
    # -----------------------------------------------------------------------------
    add_interface reset reset end
    set_interface_property reset associatedClock clk
    set_interface_property reset synchronousEdges DEASSERT
    set_interface_property reset ENABLED true
    set_interface_property reset EXPORT_OF ""
    set_interface_property reset PORT_NAME_MAP ""
    set_interface_property reset CMSIS_SVD_VARIABLES ""
    set_interface_property reset SVD_ADDRESS_GROUP ""
    
    add_interface_port reset rst reset Input 1
    
    # -----------------------------------------------------------------------------
    # Slave Interface
    # -----------------------------------------------------------------------------
{%- if bus_type == 'axil' %}
    add_interface s0 axi4lite end
    set_interface_property s0 associatedClock clk
    set_interface_property s0 associatedReset reset
    set_interface_property s0 readAcceptanceCapability 1
    set_interface_property s0 writeAcceptanceCapability 1
    set_interface_property s0 combinedAcceptanceCapability 1
    set_interface_property s0 readDataReorderingDepth 1
    set_interface_property s0 bridgesToMaster ""
    set_interface_property s0 ENABLED true
    set_interface_property s0 EXPORT_OF ""
    set_interface_property s0 PORT_NAME_MAP ""
    set_interface_property s0 CMSIS_SVD_VARIABLES ""
    set_interface_property s0 SVD_ADDRESS_GROUP ""

    add_interface_port s0 s0_awaddr awaddr Input {{ addr_width }}
    add_interface_port s0 s0_awprot awprot Input 3
    add_interface_port s0 s0_awvalid awvalid Input 1
    add_interface_port s0 s0_awready awready Output 1
    add_interface_port s0 s0_wdata wdata Input {{ data_width }}
    add_interface_port s0 s0_wstrb wstrb Input {{ data_width // 8 }}
    add_interface_port s0 s0_wvalid wvalid Input 1
    add_interface_port s0 s0_wready wready Output 1
    add_interface_port s0 s0_bresp bresp Output 2
    add_interface_port s0 s0_bvalid bvalid Output 1
    add_interface_port s0 s0_bready bready Input 1
    add_interface_port s0 s0_araddr araddr Input {{ addr_width }}
    add_interface_port s0 s0_arprot arprot Input 3
    add_interface_port s0 s0_arvalid arvalid Input 1
    add_interface_port s0 s0_arready arready Output 1
    add_interface_port s0 s0_rdata rdata Output {{ data_width }}
    add_interface_port s0 s0_rresp rresp Output 2
    add_interface_port s0 s0_rvalid rvalid Output 1
    add_interface_port s0 s0_rready rready Input 1
{%- else %}
    add_interface avs avalon end
    set_interface_property avs addressUnits WORDS
    set_interface_property avs associatedClock clk
    set_interface_property avs associatedReset reset
    set_interface_property avs bitsPerSymbol 8
    set_interface_property avs burstOnBurstBoundariesOnly false
    set_interface_property avs burstcountUnits WORDS
    set_interface_property avs explicitAddressSpan 0
    set_interface_property avs holdTime 0
    set_interface_property avs linewrapBursts false
    set_interface_property avs maximumPendingReadTransactions 1
    set_interface_property avs maximumPendingWriteTransactions 0
    set_interface_property avs readLatency 1
    set_interface_property avs readWaitTime 0
    set_interface_property avs setupTime 0
    set_interface_property avs timingUnits Cycles
    set_interface_property avs writeWaitTime 0
    set_interface_property avs ENABLED true
    set_interface_property avs EXPORT_OF ""
    set_interface_property avs PORT_NAME_MAP ""
    set_interface_property avs CMSIS_SVD_VARIABLES ""
    set_interface_property avs SVD_ADDRESS_GROUP ""
    
    add_interface_port avs avs_address address Input {{ addr_width }}
    add_interface_port avs avs_read read Input 1
    add_interface_port avs avs_readdata readdata Output {{ data_width }}
    add_interface_port avs avs_readdatavalid readdatavalid Output 1
    add_interface_port avs avs_write write Input 1
    add_interface_port avs avs_writedata writedata Input {{ data_width }}
    add_interface_port avs avs_byteenable byteenable Input {{ data_width // 8 }}
    add_interface_port avs avs_waitrequest waitrequest Output 1
{%- endif %}

{%- if user_ports %}
    # -----------------------------------------------------------------------------
    # Conduit Interface (User Ports)
    # -----------------------------------------------------------------------------
    add_interface conduit conduit end
    set_interface_property conduit associatedClock clk
    set_interface_property conduit associatedReset reset
    set_interface_property conduit ENABLED true
    set_interface_property conduit EXPORT_OF ""
    set_interface_property conduit PORT_NAME_MAP ""
    set_interface_property conduit CMSIS_SVD_VARIABLES ""
    set_interface_property conduit SVD_ADDRESS_GROUP ""
    
{%- for port in user_ports %}
    add_interface_port conduit {{ port.name }} {{ port.name }} {{ 'Output' if port.direction == 'out' else 'Input' }} {{ port.width | default(1) }}
{%- endfor %}
{%- endif %}
}

# -----------------------------------------------------------------------------
# Module Properties
# -----------------------------------------------------------------------------
set_module_property DESCRIPTION "{{ description | default('IP core with register interface') }}"
set_module_property NAME {{ entity_name }}
set_module_property VERSION {{ version | default('1.0') }}
set_module_property INTERNAL false
set_module_property OPAQUE_ADDRESS_MAP true
set_module_property AUTHOR "{{ author | default('fpga_lib') }}"
set_module_property DISPLAY_NAME "{{ display_name | default(entity_name | replace('_', ' ') | title) }}"
set_module_property INSTANTIATE_IN_SYSTEM_MODULE true
set_module_property EDITABLE true
set_module_property REPORT_TO_TALKBACK false
set_module_property ALLOW_GREYBOX_GENERATION false
set_module_property REPORT_HIERARCHY false
set_module_property VALIDATION_CALLBACK validate
set_module_property ELABORATION_CALLBACK elaborate

# -----------------------------------------------------------------------------
# File Sets
# -----------------------------------------------------------------------------
add_fileset QUARTUS_SYNTH QUARTUS_SYNTH "" ""
set_fileset_property QUARTUS_SYNTH TOP_LEVEL {{ entity_name }}
set_fileset_property QUARTUS_SYNTH ENABLE_RELATIVE_INCLUDE_PATHS false
set_fileset_property QUARTUS_SYNTH ENABLE_FILE_OVERWRITE_MODE false
add_fileset_file {{ entity_name }}_pkg.vhd VHDL PATH ../rtl/{{ entity_name }}_pkg.vhd
add_fileset_file {{ entity_name }}_core.vhd VHDL PATH ../rtl/{{ entity_name }}_core.vhd
add_fileset_file {{ entity_name }}_{{ bus_type }}.vhd VHDL PATH ../rtl/{{ entity_name }}_{{ bus_type }}.vhd
add_fileset_file {{ entity_name }}.vhd VHDL PATH ../rtl/{{ entity_name }}.vhd TOP_LEVEL_FILE

add_fileset SIM_VHDL SIM_VHDL "" ""
set_fileset_property SIM_VHDL TOP_LEVEL {{ entity_name }}
set_fileset_property SIM_VHDL ENABLE_RELATIVE_INCLUDE_PATHS false
set_fileset_property SIM_VHDL ENABLE_FILE_OVERWRITE_MODE false
add_fileset_file {{ entity_name }}_pkg.vhd VHDL PATH ../rtl/{{ entity_name }}_pkg.vhd
add_fileset_file {{ entity_name }}_core.vhd VHDL PATH ../rtl/{{ entity_name }}_core.vhd
add_fileset_file {{ entity_name }}_{{ bus_type }}.vhd VHDL PATH ../rtl/{{ entity_name }}_{{ bus_type }}.vhd
add_fileset_file {{ entity_name }}.vhd VHDL PATH ../rtl/{{ entity_name }}.vhd TOP_LEVEL_FILE

# -----------------------------------------------------------------------------
# Parameters
# -----------------------------------------------------------------------------
{%- for generic in generics %}
add_parameter {{ generic.name | upper }} {{ generic.type | upper }} {{ generic.default_value }}
set_parameter_property {{ generic.name | upper }} DEFAULT_VALUE {{ generic.default_value }}
set_parameter_property {{ generic.name | upper }} DISPLAY_NAME "{{ generic.name | replace('_', ' ') | title }}"
set_parameter_property {{ generic.name | upper }} TYPE {{ generic.type | upper }}
set_parameter_property {{ generic.name | upper }} UNITS None
set_parameter_property {{ generic.name | upper }} HDL_PARAMETER true
set_parameter_property {{ generic.name | upper }} AFFECTS_GENERATION false
set_parameter_property {{ generic.name | upper }} AFFECTS_ELABORATION true

{%- endfor %}
