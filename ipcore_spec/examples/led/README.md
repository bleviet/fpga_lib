# LED Controller IP Core Example

This directory contains a complete LED controller IP core example for testing VHDL generation with Altera and Xilinx FPGAs.

## Overview

The LED controller is a configurable IP core with an AXI-Lite interface that provides:
- Control of up to 32 LED outputs (configurable via NUM_LEDS generic)
- Direct LED on/off control
- PWM brightness control capability  
- Blink pattern generation
- Interrupt generation for events
- Simple control/status register interface

## Files

### Specification Files
- `led_controller.ip.yml` - IP core definition including ports, clocks, resets, parameters, and bus interfaces
- `led_controller.mm.yml` - Memory map specification defining the control/status registers

### Generated Files

#### RTL (rtl/)
- `led_controller_pkg.vhd` - Package with register types and constants
- `led_controller.vhd` - Top-level wrapper integrating bus interface and core logic
- `led_controller_core.vhd` - Core LED control logic (placeholder for custom implementation)
- `led_controller_axil.vhd` - AXI-Lite bus interface wrapper
- `led_controller_regs.vhd` - Register file implementation

#### Testbench (tb/)
- `led_controller_test.py` - Full cocotb testbench with automated register testing
- `simple_test.py` - Minimal test for quick verification
- `Makefile` - Build system for running GHDL simulations
- `led_controller_memmap.yml` - Memory map for Python driver generation

#### Integration Files
- `intel/led_controller_hw.tcl` - Intel Platform Designer (Qsys/Platform Designer) integration
- `xilinx/component.xml` - Xilinx Vivado IP-XACT component definition

## Register Map

| Address | Register     | Access | Description                              |
|---------|--------------|--------|------------------------------------------|
| 0x00    | CONTROL      | RW     | Global control (enable, PWM, blink, IRQ) |
| 0x04    | STATUS       | RO     | Status register (ready, error flags)     |
| 0x08    | LED_OUTPUT   | RW     | Direct LED state control (32 bits)       |

### CONTROL Register (0x00)
- Bit 0: ENABLE - Global enable for LED controller
- Bit 1: PWM_ENABLE - Enable PWM brightness control
- Bit 2: BLINK_ENABLE - Enable blink pattern generator
- Bit 3: IRQ_ENABLE - Enable interrupt generation
- Bits 31:4: Reserved

### STATUS Register (0x04)
- Bit 0: READY - Controller ready flag
- Bit 1: ERROR - Error condition detected
- Bits 31:2: Reserved

### LED_OUTPUT Register (0x08)
- Bits 31:0: LED_STATE - Direct control of LED outputs (1=on, 0=off)

## Parameters/Generics

- `NUM_LEDS` (default: 8) - Number of LED outputs (1-32)
- `PWM_BITS` (default: 8) - PWM resolution for brightness control (4-16 bits)
- `BLINK_COUNTER_WIDTH` (default: 24) - Width of blink timer counter (16-32 bits)


## Generating the Core

This IP core is generated using the `ipcore` CLI tool (or VS Code extension).

### Using CLI
```bash
# from project root
uv run scripts/ipcore.py generate \
  ipcore_spec/examples/led/led_controller.ip.yml \
  --output ipcore_spec/examples/led \
  --vendor both \
  --force
```

## Running Tests

### Prerequisites
- GHDL (VHDL simulator)
- Python 3.8+ (managed via `uv`)

### Run Tests
```bash
# from project root
uv run pytest ipcore_spec/examples/led/tb/led_controller_test.py
```

## Integration with FPGAs

### Altera/Intel Platform Designer
1. Use generated `intel/led_controller_hw.tcl`
2. In Platform Designer, refresh IP catalog
3. Add "led_controller" component to your system

### Xilinx Vivado
1. Use generated `xilinx/component.xml`
2. In Vivado: Settings → IP → Repository → Add Repository
3. Select the `xilinx` directory

## Customization

To add custom LED control logic, modify `rtl/led_controller_core.vhd`:
- Access registers via `regs_in` (SW→HW)
- Update status via `regs_out` (HW→SW)  
- Drive `o_led` and `o_led_pwm` outputs
- Assert `o_irq` for interrupts

Example:
```vhdl
-- In led_controller_core.vhd
process(clk)
begin
  if rising_edge(clk) then
    if rst = '1' then
      o_led <= (others => '0');
    elsif regs_in.control.enable = '1' then
      -- Drive LEDs from register
      o_led(NUM_LEDS-1 downto 0) <= regs_in.led_output.led_state(NUM_LEDS-1 downto 0);
    end if;
  end if;
end process;
```

## License

Generated by fpga_lib VHDL Generator
